<script setup lang="ts">
  import { useRoute } from "vue-router";
  import router from "~/router/router";
  import AddIcon from "~/components/Icons/AddIcon.vue";
  import Link from "~/components/Link/Link.vue";
  import TrashIcon from "~/components/Icons/TrashIcon.vue";
  import EditIcon from "~/components/Icons/EditIcon.vue";
  import Button from "~/components/Button/Button.vue";
  import ActivityList from "~/components/ActivityList/ActivityList.vue";
  import { ButtonColor, ButtonSize, getDayOfTheWeek, LinkType } from "~/utils";
  import { useUserStore } from "~/stores/user";
  import { useTimerStore } from "~/stores/timer";
  import { useSettingStore } from "~/stores/settings";
  import { useActivityStore } from "~/stores/activity";
  import { ref } from "vue";

  const route = useRoute();
  const activityStore = useActivityStore();
  const settingsStore = useSettingStore();
  const userStore = useUserStore();
  const timerStore = useTimerStore();

  const sessionId = route.params.sessionId as string;

  let session = activityStore.getSession(sessionId);
  let activityList = ref(undefined as any[] | undefined);
  let warmupList = ref(undefined as any[] | undefined);

  warmupList.value = activityStore.getWarmUpActivities(sessionId);
  activityList.value = activityStore.getSessionActivities(sessionId);

  settingsStore.setHeader(getDayOfTheWeek(session?.dayOfWeek));

  async function deleteSession() {
    await activityStore.deleteSession(sessionId);
    router.back();
  }

  function runWarmUp() {
    timerStore.setListActivities(warmupList.value);
    router.push({ name: "timer", params: { sessionId } });
  }

  function runActivities() {
    timerStore.setListActivities(activityList.value);
    router.push({ name: "timer", params: { sessionId } });
  }

  function duplicateWarmup() {
    activityStore.setDuplicateWarmup(warmupList.value);
    router.push({
      name: "session",
      params: { sessionId },
      query: { d: "duplicate" },
    });
  }

  function sortActivities(evt: any) {
    const { newDraggableIndex, oldDraggableIndex } = evt;
    activityStore.moveActivity(
      session?.id,
      newDraggableIndex,
      oldDraggableIndex
    );
  }
</script>
<template>
  <div
    class="flex mb-6 gap-2"
    v-if="userStore.isTrainer || userStore.isSelfMadeMan"
  >
    <Link
      :to="{ name: 'session', params: { sessionId } }"
      label="Edit session"
      :type="LinkType.BUTTON"
      :icon="EditIcon"
    ></Link>
    <Button
      :color="ButtonColor.DANGER"
      :icon="TrashIcon"
      :size="ButtonSize.MEDIUM"
      label="Delete session"
      @click="deleteSession"
    ></Button>
    <Link
      v-if="userStore.isTrainer || userStore.isSelfMadeMan"
      :icon="AddIcon"
      :size="ButtonSize.MEDIUM"
      :color="ButtonColor.SUCCESS"
      :to="{ name: 'activity', params: { sessionId } }"
      :type="LinkType.BUTTON"
      label="Add activity"
    />
  </div>
  <div class="flex flex-col justify-center">
    <ActivityList
      :activities="warmupList"
      :is-warmup="true"
      :session-id="sessionId"
      @duplicate="duplicateWarmup"
      @run="runWarmUp"
      @move="sortActivities"
    ></ActivityList>
    <ActivityList
      :activities="activityList"
      @run="runActivities"
      @move="sortActivities"
      :session-id="sessionId"
    ></ActivityList>
  </div>
</template>
