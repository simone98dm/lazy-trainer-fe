<script setup lang="ts">
  import { useRoute } from "vue-router";
  import router from "~/router/router";
  import Link from "~/components/Link/Link.vue";
  import Button from "~/components/Button/Button.vue";
  import ActivityList from "~/components/ActivityList/ActivityList.vue";
  import BackButton from "~/components/BackButton/BackButton.vue";
  import { ButtonColor, ButtonSize, getDayOfTheWeek, LinkType } from "~/utils";
  import { useUserStore } from "~/stores/user";
  import { useTimerStore } from "~/stores/timer";
  import { useSettingStore } from "~/stores/settings";
  import { useActivityStore } from "~/stores/activity";
  import { ref } from "vue";

  const route = useRoute();
  const activityStore = useActivityStore();
  const settingsStore = useSettingStore();
  const userStore = useUserStore();
  const timerStore = useTimerStore();

  const sessionId = route.params.sessionId as string;

  let session = activityStore.getSession(sessionId);
  let activityList = ref(undefined as any[] | undefined);
  let warmupList = ref(undefined as any[] | undefined);

  warmupList.value = activityStore.getWarmUpActivities(sessionId);
  activityList.value = activityStore.getSessionActivities(sessionId);

  settingsStore.setHeader(getDayOfTheWeek(session?.dayOfWeek));

  async function deleteSession() {
    await activityStore.deleteSession(sessionId);
    router.back();
  }

  function runWarmUp() {
    timerStore.setListActivities(warmupList.value);
    router.push({ name: "timer", params: { sessionId } });
  }

  function runActivities() {
    timerStore.setListActivities(activityList.value);
    router.push({ name: "timer", params: { sessionId } });
  }

  function duplicateWarmup() {
    activityStore.setDuplicateWarmup(warmupList.value);
    router.push({
      name: "session",
      params: { sessionId },
      query: { d: "duplicate" },
    });
  }

  function sortActivities(evt: any) {
    const { newDraggableIndex, oldDraggableIndex } = evt;
    activityStore.moveActivity(
      session?.id,
      newDraggableIndex,
      oldDraggableIndex
    );
  }
</script>
<template>
  <div class="mb-6">
    <BackButton @click="router.push({ name: 'home' })" />
  </div>
  <div
    class="flex mb-6 gap-2"
    v-if="userStore.isTrainer || userStore.isSelfMadeMan"
  >
    <Link
      id="edit-session"
      :to="{ name: 'session', params: { sessionId } }"
      label="Edit"
      :type="LinkType.BUTTON"
      icon="edit"
    ></Link>
    <Button
      id="delete-session"
      :color="ButtonColor.DANGER"
      icon="delete"
      :size="ButtonSize.MEDIUM"
      label="Delete"
      @click="deleteSession"
    ></Button>
    <Link
      v-if="userStore.isTrainer || userStore.isSelfMadeMan"
      id="add-activity"
      icon="add"
      :size="ButtonSize.MEDIUM"
      :color="ButtonColor.SUCCESS"
      :to="{ name: 'activity', params: { sessionId } }"
      :type="LinkType.BUTTON"
      label="Add"
    />
  </div>
  <div class="flex flex-col justify-center">
    <div id="warmup-activities">
      <ActivityList
        :activities="warmupList"
        :is-warmup="true"
        :session-id="sessionId"
        @duplicate="duplicateWarmup"
        @run="runWarmUp"
        @move="sortActivities"
      ></ActivityList>
    </div>
    <div id="list-activities">
      <ActivityList
        :activities="activityList"
        @run="runActivities"
        @move="sortActivities"
        :session-id="sessionId"
      ></ActivityList>
    </div>
  </div>
</template>
