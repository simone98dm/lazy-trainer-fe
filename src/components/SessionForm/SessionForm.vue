<script setup lang="ts">
  import { ref } from "vue";
  import Button from "~/components/Button/Button.vue";
  import { v4 as uuidv4 } from "uuid";
  import { ISession } from "~/models/Session";
  import { days, ButtonColor, getDayOfTheWeek } from "~/utils";
  import { useActivityStore } from "~/stores/activity";
  import { useUserStore } from "~/stores/user";

  const props = defineProps(["id", "dayOfWeek", "existingForm"]);
  const emits = defineEmits(["save", "remove"]);

  const activityStore = useActivityStore();
  const userStore = useUserStore();

  const uuid = uuidv4();

  let dayOfWeek = ref(props.dayOfWeek || 0);
  let id = ref(props.id || uuid);

  function save() {
    const activity: ISession = {
      id: id.value,
      dayOfWeek: dayOfWeek.value,
      activities: [],
    };

    if (props.existingForm) {
      activityStore.duplicateWarmup = undefined;
      activity.activities = [...props.existingForm];
      activity.id = uuidv4();
    }

    emits("save", activity);
  }

  function isNew() {
    return !Boolean(props.id);
  }

  function remove() {
    if (!isNew()) {
      emits("remove", props.id);
    }
  }

  function selectDay(dayIndex: number) {
    dayOfWeek.value = dayIndex;
  }

  function isDaySelected(dayIndex: number) {
    return dayIndex === dayOfWeek.value;
  }
</script>

<template>
  <div class="flex justify-center w-full">
    <form class="bg-white rounded-lg shadow-md p-6 w-full" @submit.prevent>
      <div>
        <h1 v-if="isNew()" class="mb-3 text-2xl font-bold mb-6">
          Create a new day session:
        </h1>
        <h1 v-else class="mb-3 text-2xl font-bold mb-6">
          Edit {{ getDayOfTheWeek(dayOfWeek) }} session:
        </h1>
        <div class="flex xl:flex-row flex-col justify-center gap-3 mb-6">
          <button
            v-for="day in activityStore.getMissingDays"
            :key="day"
            :class="[
              {
                'bg-indigo-600 text-slate-50':
                  isDaySelected(day) && !userStore.isTrainer,
              },
              {
                'bg-purple-600 text-slate-50':
                  isDaySelected(day) && userStore.isTrainer,
              },
              { 'bg-gray-200 text-grey-50': !isDaySelected(day) },
              'w-full duration-200 rounded-full px-4 py-2 ',
            ]"
            @click="() => selectDay(day)"
          >
            {{ getDayOfTheWeek(day) }}
          </button>
        </div>
      </div>
      <div
        v-if="props.existingForm"
        class="mb-6 text-center rounded-xl shadow-lg bg-orange-200 p-4"
      >
        <p class="text-red-500 mb-3">
          *This session will contains the warm-up activities from the other
          session.
        </p>
        <div class="w-full flex flex-wrap justify-center gap-3">
          <span
            v-for="warmup in props.existingForm"
            class="bg-purple-600 rounded-lg p-2 text-white"
            >{{ warmup.name }}</span
          >
        </div>
      </div>
      <div class="w-full flex flex-col sm:flex-row justify-center px-3 gap-3">
        <Button
          full="true"
          :icon="!isNew() ? 'save' : 'add'"
          :label="!isNew() ? 'Save' : 'Create'"
          :color="ButtonColor.SUCCESS"
          @click="save"
        />
        <Button
          full="true"
          v-if="!isNew()"
          icon="delete"
          :color="ButtonColor.DANGER"
          label="Delete"
          @click="remove"
        />
      </div>
    </form>
  </div>
</template>
